<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Inventory | Vinvel</title>

    <!-- Favicons (favicon_io) -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico">
    <link rel="manifest" href="favicon_io/site.webmanifest">
    <meta name="theme-color" content="#ffffff">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Jost:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6600FF 0%, #00CCFF 100%);
            --text-dark: #1A1A1A;
            --text-grey: #666666;
            --bg-light: #F8F9FA;
            --white: #FFFFFF;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-grey); display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        h1, h2, h3, h4 { font-family: 'Jost', sans-serif; color: var(--text-dark); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* HEADER */
        header { background: rgba(255,255,255,0.97); padding: 12px 0; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
        .logo { display:flex; align-items:center; gap:10px; }
        .logo img { height:64px; width:auto; display:block; }

        @media (max-width: 640px) {
            .logo img { height:56px; }
        }
        
        /* LAYOUT GRID */
        .inventory-wrapper { display: grid; grid-template-columns: 260px 1fr; gap: 30px; padding: 30px 0 40px; flex: 1; align-items: start; }
        
        /* SIDEBAR FILTERS */
        .sidebar { background: white; padding: 25px; border-radius: var(--radius-md); box-shadow: var(--card-shadow); position: sticky; top: 90px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-group { margin-bottom: 20px; }
        .filter-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-dark); }
        .filter-group select, .filter-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; outline: none; }
        .filter-btn { width: 100%; background: var(--primary-gradient); color: white; padding: 12px; border: none; border-radius: 999px; cursor: pointer; margin-top: 10px; font-family: 'Jost', sans-serif; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.02em; transition: 0.25s ease; box-shadow: 0 4px 12px rgba(102,0,255,0.35); }
        .filter-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 18px rgba(102,0,255,0.5); }
        .reset-btn { width: 100%; background: transparent; color: #666; padding: 8px; border: none; cursor: pointer; margin-top: 5px; font-size: 0.85rem; text-decoration: underline; }

        /* MAIN LIST AREA & VIEW CONTROLS */
        .car-list { min-width: 0; }
        
        .list-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .view-toggles { display: flex; gap: 10px; align-items: center; }
        .view-btn { background: white; border: 1px solid #ddd; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; color: #666; transition: 0.2s; }
        .view-btn.active { background: #6600FF; color: white; border-color: #6600FF; }

        /* PAGINATION */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; gap: 16px; flex-wrap: wrap; font-size: 0.9rem; color: #555; }
        .page-controls { display: flex; gap: 8px; align-items: center; }
        .page-btn { padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.85rem; min-width: 34px; text-align: center; transition: 0.2s; }
        .page-btn:hover { background: #f3f3ff; border-color: #6600FF; }
        .page-btn.active { background: #6600FF; color: #fff; border-color: #6600FF; }
        .page-btn[disabled] { opacity: 0.4; cursor: default; background: #f5f5f5; }
        .page-size-select { padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 0.85rem; }
        
        .search-bar-top { width: 100%; position: relative; max-width: 400px; }
        .search-bar-top input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 50px; border: 1px solid #ddd; font-size: 0.95rem; outline: none; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; font-size: 1rem; }

        /* CAR GRID SYSTEM */
        .grid-container { display: grid; gap: 25px; transition: 0.3s; align-items: stretch; }
        .cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

        /* CAR CARD */
        .car-card { 
            background: white; 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
            box-shadow: var(--card-shadow); 
            transition: 0.3s; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            border: 1px solid #eee; 
            height: 100%;
        }
        .car-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(102, 0, 255, 0.1); border-color: #00CCFF; }
        
        /* IMAGE WRAPPER */
        .car-img-wrapper { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 16/10; 
            background: #f0f0f0; 
            overflow: hidden;
        }
        .car-img-wrapper img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: center;
            transition: 0.5s;
        }
        .car-card:hover .car-img-wrapper img { transform: scale(1.05); }

        .badge-grade { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(4px); z-index: 2; }
        .badge-status { position: absolute; top: 10px; left: 10px; padding: 3px 10px; border-radius: 999px; font-size: 0.72rem; font-weight: 600; color: #fff; z-index: 2; letter-spacing: 0.04em; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.18); }
        .badge-status.ready { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .badge-status.transit { background: linear-gradient(135deg, #eab308, #f97316); }
        .badge-status.arrived { background: linear-gradient(135deg, #2563eb, #4f46e5); }
        
        .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 5px; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { display: flex; gap: 8px; font-size: 0.75rem; color: #888; margin-bottom: 12px; flex-wrap: wrap; }
        .card-meta span { display: flex; align-items: center; gap: 4px; background: #f9f9f9; padding: 3px 6px; border-radius: 4px; }
        
        .price-tag { font-family: 'Jost', sans-serif; font-size: 1.2rem; font-weight: 700; color: #6600FF; display: block; margin-bottom: 12px; }
        .price-hidden { color: #333; font-size: 1rem; }
        
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: auto; }
        .btn-view, .btn-whatsapp { padding: 9px 10px; border-radius: 999px; font-size: 0.82rem; font-family: 'Jost', sans-serif; font-weight: 600; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; border: none; letter-spacing: 0.02em; transition: 0.25s ease; }
        .btn-view { background: #f3f3ff; color: #3b3b5a; border: 1px solid rgba(102,0,255,0.18); }
        .btn-view:hover { background: #6600FF; color: #fff; box-shadow: 0 6px 16px rgba(102,0,255,0.4); }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 12px rgba(37,211,102,0.4); }
        .btn-whatsapp:hover { background: #1ebc57; box-shadow: 0 6px 18px rgba(37,211,102,0.5); transform: translateY(-1px); }

        /* MODAL STYLES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 14px; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 100%; max-width: 1000px; max-height: 92vh; border-radius: 20px; overflow: hidden; display: flex; position: relative; animation: slideUp 0.3s ease; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: #333; cursor: pointer; z-index: 10; background: rgba(255,255,255,0.8); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .modal-close:hover { background: #ff4d4d; color: white; }
        .modal-gallery { flex: 1.5; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .modal-gallery img { width: 100%; height: 100%; object-fit: contain; }
        .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 15px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .carousel-btn:hover { background: rgba(255,255,255,0.4); }
        .prev-btn { left: 0; } .next-btn { right: 0; }
        .modal-details { flex: 1; padding: 26px 24px 28px; overflow-y: auto; background: white; }
        .modal-title { font-size: 1.8rem; margin-bottom: 6px; }
        .modal-price-row { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
        .modal-price { font-size: 1.6rem; color: #6600FF; font-family: 'Jost'; font-weight: 700; display: block; }
        .modal-status-pill { font-size: 0.8rem; font-weight: 600; padding: 6px 12px; border-radius: 999px; text-transform: uppercase; letter-spacing: 0.06em; }
        .modal-status-ready { background: linear-gradient(135deg, #16a34a, #22c55e); color: #fff; }
        .modal-status-transit { background: linear-gradient(135deg, #eab308, #f97316); color: #fff; }
        .modal-status-arrived { background: linear-gradient(135deg, #2563eb, #4f46e5); color: #fff; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .spec-item { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.9rem; }
        .spec-item strong { display: block; color: #888; font-size: 0.75rem; margin-bottom: 3px; }

        /* FOOTER */
        footer { background: radial-gradient(circle at top left, #1b1433 0, #05040a 55%, #020308 100%); color: #b5bcd1; padding: 48px 0 26px; border-top: 1px solid rgba(255,255,255,0.05); margin-top: auto; }
        .footer-grid { display: grid; grid-template-columns: minmax(0, 2fr) repeat(3, minmax(0, 1.1fr)); gap: 32px; margin-bottom: 32px; align-items: flex-start; }
        .footer-col h3 { color: #f5f6ff; margin-bottom: 18px; font-size: 0.98rem; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.8; }
        .footer-tagline { margin-top: 8px; font-size: 0.92rem; color: #d0d4e4; }
        .footer-logo-text { font-family: 'Jost', sans-serif; font-size: 2.2rem; color: #ffffff; font-weight: 700; display: inline-flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .footer-logo-dot { width: 9px; height: 9px; border-radius: 999px; background: linear-gradient(135deg, #6600FF, #00CCFF); box-shadow: 0 0 14px rgba(102,0,255,0.8); }
        .footer-meta { margin-top: 16px; font-size: 0.86rem; color: #9aa2c0; }
        .footer-meta span { display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; }
        .footer-meta i { font-size: 0.9rem; color: #7c8cff; }
        .footer-links ul { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { font-size: 0.93rem; color: #c2c8dd; display: inline-flex; align-items: center; gap: 8px; padding: 4px 0; position: relative; overflow: hidden; }
        .footer-links a::before { content: ""; position: absolute; left: 0; bottom: 0; width: 0; height: 1px; background: linear-gradient(90deg, #6600FF, #00CCFF); transition: width 0.25s ease; }
        .footer-links a:hover { color: #ffffff; transform: translateX(2px); }
        .footer-links a:hover::before { width: 100%; }
        .footer-links i { width: 16px; text-align: center; color: #7c8cff; }
        .footer-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); font-size: 0.78rem; color: #9aa2c0; margin-bottom: 6px; }
        .footer-pill i { color: #7c8cff; font-size: 0.8rem; }
        .footer-bottom { display: flex; justify-content: space-between; align-items: center; gap: 16px; padding-top: 18px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 0.82rem; color: #8d93aa; flex-wrap: wrap; }
        .footer-bottom-links { display: flex; gap: 16px; flex-wrap: wrap; }
        .footer-bottom a { color: #a4aac4; }
        .footer-bottom a:hover { color: #ffffff; }

        @media (max-width: 900px) {
            .footer-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); row-gap: 28px; }
        }

        @media (max-width: 640px) {
            footer { padding: 40px 0 24px; }
            .footer-grid { grid-template-columns: minmax(0, 1fr); gap: 20px; }
            .footer-logo-text { font-size: 1.9rem; }
            .footer-bottom { flex-direction: column-reverse; align-items: flex-start; }
        }

        /* MOBILE RESPONSIVE */
        .mobile-filter-toggle { display: none; width: 100%; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 8px; font-weight: 600; margin-bottom: 20px; text-align: center; cursor: pointer; }
        
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 900px) {
            .inventory-wrapper { display: block; padding-top: 20px; }
            .sidebar { display: none; margin-bottom: 20px; position: static; top: auto; box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
            .sidebar.active { display: block; }
            .mobile-filter-toggle { display: block; }
            .view-toggles { display: none; } 
            .grid-container { grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)) !important; }
            .list-controls { align-items: flex-start; gap: 12px; }
            .list-controls h2 { width: 100%; font-size: 1.25rem; }
            .modal-content { flex-direction: column; height: auto; max-height: 100vh; border-radius: 18px; }
            .modal-gallery { height: 38vh; flex: none; }
            .modal-details { flex: 1; padding: 20px 18px 22px; }
            .modal-title { font-size: 1.4rem; }
            .modal-price { font-size: 1.3rem; }
            .spec-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        }

        @media (max-width: 600px) {
            header { padding: 10px 0; }
            .nav-inner { gap: 8px; }
            .logo { font-size: 1.4rem; }
            .inventory-wrapper { padding: 20px 0 30px; }
            .sidebar { padding: 18px 16px; }
            .filter-group { margin-bottom: 14px; }
            .filter-group label { font-size: 0.85rem; }
            .filter-group select, .filter-group input { padding: 8px 9px; font-size: 0.85rem; }
            .filter-btn { padding: 10px; }
            .grid-container { gap: 18px; }
            .car-card { border-radius: 14px; }
            .card-body { padding: 12px 12px 14px; }
            .card-title { font-size: 0.98rem; }
            .card-meta { font-size: 0.7rem; }
            .price-tag { font-size: 1.05rem; }
            .card-actions { grid-template-columns: 1fr; }
            .btn-view, .btn-whatsapp { font-size: 0.8rem; padding: 7px 9px; }
            .modal-overlay { padding: 10px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container nav-inner">
            <a href="index.html" class="logo"><img src="img/logo.svg" alt="Vinvel Motor Trading logo"></a>
            <div style="display:flex; align-items:center; gap:14px;">
                <a href="auction.html" style="font-size:0.88rem; font-weight:500; color:#111827; display:inline-flex; align-items:center; gap:6px; padding:7px 12px; border-radius:999px; border:1px solid rgba(148,163,184,0.55); background:rgba(15,23,42,0.02);">
                    <i class="fa-solid fa-gavel" style="color:#4f46e5;"></i>
                    <span>Auction Picks</span>
                </a>
                <a href="index.html" style="font-weight: 500; color: var(--text-dark); display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-arrow-left"></i> <span style="font-size: 0.9rem;">Back to Home</span>
                </a>
            </div>
        </div>
    </header>

    <div class="container inventory-wrapper">
        
        <button class="mobile-filter-toggle" onclick="toggleSidebar()">
            <i class="fa-solid fa-sliders"></i> Filters
        </button>

        <aside class="sidebar" id="filterSidebar">
            <div class="sidebar-header">
                <h3>Filter Cars</h3>
                <i class="fa-solid fa-xmark" style="cursor: pointer; display: none;" onclick="toggleSidebar()" id="closeFilters"></i>
            </div>
            
            <div class="filter-group">
                <label>Make</label>
                <select id="makeSelect" onchange="applyFilters()">
                    <option value="All">All Makes</option>
                    </select>
            </div>

            <div class="filter-group">
                <label>Model</label>
                <select id="modelSelect" onchange="applyFilters()">
                    <option value="All">All Models</option>
                    </select>
            </div>

            <div class="filter-group">
                <label>Min Year</label>
                <input type="number" id="minYear" placeholder="e.g. 2015" onkeyup="applyFilters()">
            </div>

             <div class="filter-group">
                <label>Max Price (LKR)</label>
                <input type="number" id="maxPrice" placeholder="e.g. 10000000" onkeyup="applyFilters()">
            </div>

            <button class="filter-btn" onclick="applyFilters()">Apply Filters</button>
            <button class="reset-btn" onclick="resetFilters()">Reset All</button>
        </aside>

        <main class="car-list">
            
            <div class="list-controls">
                <h2 id="resultCount" style="font-size: 1.4rem;">Loading inventory...</h2>
                
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div class="search-bar-top">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="applyFilters()">
                    </div>

                    <div class="view-toggles">
                        <span style="font-size: 0.85rem; font-weight: 600;">View:</span>
                        <button class="view-btn active" onclick="setGrid(2, this)" title="2 per row">2</button>
                        <button class="view-btn" onclick="setGrid(3, this)" title="3 per row">3</button>
                    </div>
                </div>
            </div>

            <div class="grid-container cols-2" id="carsGrid">
                </div>
            <div class="pagination-bar" id="paginationBar" style="display:none;">
                <div id="paginationInfo">Showing 0 of 0 cars</div>
                <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                    <div>
                        <label for="pageSizeSelect" style="margin-right:6px;">Per page:</label>
                        <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize()">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    <div class="page-controls" id="pageControls"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="carModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModal()">&times;</div>
            <div class="modal-gallery">
                <button class="carousel-btn prev-btn" onclick="changeSlide(-1)">&#10094;</button>
                <img id="modalImage" src="" alt="Car Detail">
                <button class="carousel-btn next-btn" onclick="changeSlide(1)">&#10095;</button>
            </div>
            <div class="modal-details">
                <h2 class="modal-title" id="modalTitle">Car Title</h2>
                <div class="modal-price-row">
                    <span class="modal-price" id="modalPrice">LKR 0</span>
                    <span id="modalStatus" class="modal-status-pill modal-status-ready">Ready to Ship</span>
                </div>
                <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem;">
                    Verified Auction Grade <span id="modalGrade" style="font-weight: 700; color: #333;">4.5</span>. 
                    This vehicle includes a full translation sheet and mechanical warranty.
                </p>
                <div class="spec-grid">
                    <div class="spec-item"><strong>Year</strong> <span id="modalYear">2019</span></div>
                    <div class="spec-item"><strong>Mileage</strong> <span id="modalMileage">45k km</span></div>
                    <div class="spec-item"><strong>Engine</strong> <span id="modalEngine">1.5L</span></div>
                    <div class="spec-item"><strong>Fuel</strong> <span id="modalFuel">Petrol</span></div>
                    <div class="spec-item"><strong>Transmission</strong> <span id="modalTrans">Auto</span></div>
                    <div class="spec-item"><strong>Ref ID</strong> <span id="modalRef">001</span></div>
                </div>
                <a href="#" id="modalWhatsapp" class="btn-whatsapp" style="width: 100%; padding: 15px; font-size: 1rem;">
                    <i class="fa-brands fa-whatsapp"></i> Enquire Now on WhatsApp
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { getInventory, urlFor, getCarImages } from './js/sanity-client.js';

        let allCars = [];
        let filteredCars = [];
        let currentPage = 1;
        let pageSize = 10;
        let currentCarImages = []; // For modal gallery
        let currentSlideIndex = 0;

        // --- INIT ---
        async function initInventory() {
            const grid = document.getElementById('carsGrid');
            const countLabel = document.getElementById('resultCount');
            
            try {
                // Fetch only 'inventory' cars (non-auction)
                // getInventory() in sanity-client.js filters for stockType == "inventory"
                allCars = await getInventory();
                
                filteredCars = allCars;
                populateDropdowns(allCars);
                render();
            } catch (error) {
                console.error("Sanity Error:", error);
                grid.innerHTML = "<p>Sorry, we couldn't load the inventory. Please try again later.</p>";
                countLabel.innerText = "Error Loading Data";
            }
        }

        // --- RENDER LOGIC ---
        function render() {
            const total = filteredCars.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageItems = filteredCars.slice(start, end);
            
            displayCars(pageItems, total);
            updatePagination(total, totalPages);
        }

        function displayCars(cars, totalCount) {
            const grid = document.getElementById('carsGrid');
            const countLabel = document.getElementById('resultCount');
            grid.innerHTML = "";
            
            if (cars.length === 0) {
                grid.innerHTML = "<div style='grid-column: 1/-1; text-align:center; padding: 40px;'><p>No cars found matching your criteria.</p></div>";
                countLabel.innerText = "0 Results";
                return;
            }

            countLabel.innerText = `Showing ${cars.length} of ${totalCount} Results`;

            cars.forEach(car => {
                const priceDisplay = car.hidePrice 
                    ? "Call for Price" 
                    : `LKR ${car.price ? car.price.toLocaleString() : '0'}`;
                
                const priceClass = car.hidePrice ? "price-tag price-hidden" : "price-tag";
                
                // Use first image as thumbnail
                const thumbUrl = car.images && car.images.length > 0 
                    ? urlFor(car.images[0]).width(800).height(500).url() 
                    : 'https://via.placeholder.com/800x500?text=No+Image';

                // Status Logic
                let statusLabel = car.status || "Ready to Ship";
                let statusClass = "ready";
                if (statusLabel.includes("Transit")) statusClass = "transit";
                if (statusLabel.includes("Arrived")) statusClass = "arrived";

                // We'll attach the ID to buttons so they can call openModal defined on window
                const cardHTML = `
                    <div class="car-card">
                        <div class="car-img-wrapper">
                            <span class="badge-status ${statusClass}">${statusLabel}</span>
                            <span class="badge-grade">Grade ${car.grade || '-'}</span>
                            <img src="${thumbUrl}" alt="${car.title}" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                        </div>
                        <div class="card-body">
                            <div>
                                <h3 class="card-title" title="${car.title}">${car.title}</h3>
                                <div class="card-meta">
                                    <span>${car.year}</span>
                                    <span>${car.mileage}</span>
                                    <span>${car.engine}</span>
                                </div>
                            </div>
                            <div>
                                <span class="${priceClass}">${priceDisplay}</span>
                                <div class="card-actions">
                                    <button class="btn-view" onclick="window.openModal('${car._id}')">View Details</button>
                                    <button class="btn-whatsapp" onclick="window.openWhatsApp(event, '${car.title}', '${car._id}')">
                                        <i class="fa-brands fa-whatsapp"></i> Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHTML;
            });
        }

        // --- FILTERS ---
        window.applyFilters = () => {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const make = document.getElementById('makeSelect').value;
            const model = document.getElementById('modelSelect').value;
            const minYear = document.getElementById('minYear').value;
            const maxPrice = document.getElementById('maxPrice').value;

            filteredCars = allCars.filter(car => {
                // Safe checks for potentially missing fields
                const cTitle = (car.title || "").toLowerCase();
                const cMake = car.make || "";
                const cModel = car.model || "";
                const cYear = car.year || 0;
                const cPrice = car.price || 0;

                const matchesSearch = cTitle.includes(searchText) || (car._id && car._id.includes(searchText));
                const matchesMake = (make === "All") || (cMake === make);
                const matchesModel = (model === "All") || (cModel === model);
                const matchesYear = !minYear || (cYear >= parseInt(minYear));
                const matchesPrice = !maxPrice || (cPrice > 0 && cPrice <= parseInt(maxPrice));
                
                return matchesSearch && matchesMake && matchesModel && matchesYear && matchesPrice;
            });

            currentPage = 1;
            render();
        };

        // Populate dropdowns based on actual data
        function populateDropdowns(cars) {
            const makeSelect = document.getElementById('makeSelect');
            const modelSelect = document.getElementById('modelSelect');
            
            const makes = new Set();
            const models = new Set();
            
            cars.forEach(c => {
                if(c.make) makes.add(c.make);
                if(c.model) models.add(c.model);
            });

            // Populate Makes
            makes.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                makeSelect.appendChild(opt);
            });

            // Populate Models (Initial Load: All)
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                modelSelect.appendChild(opt);
            });
        }

        window.resetFilters = () => {
            document.getElementById('searchInput').value = "";
            document.getElementById('makeSelect').value = "All";
            document.getElementById('modelSelect').value = "All";
            document.getElementById('minYear').value = "";
            document.getElementById('maxPrice').value = "";
            filteredCars = allCars;
            currentPage = 1;
            render();
        };

        // --- PAGINATION & GRID UI ---
        function updatePagination(total, totalPages) {
            const bar = document.getElementById('paginationBar');
            const info = document.getElementById('paginationInfo');
            const controls = document.getElementById('pageControls');

            if (total <= pageSize) {
                bar.style.display = 'none';
                return;
            }

            bar.style.display = 'flex';
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);
            info.textContent = `Showing ${start}-${end} of ${total} cars`;

            controls.innerHTML = '';

            // Prev Button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '<';
            prevBtn.className = 'page-btn';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; render(); } };
            controls.appendChild(prevBtn);

            // Numbered Buttons
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                btn.onclick = () => { currentPage = i; render(); };
                controls.appendChild(btn);
            }

            // Next Button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '>';
            nextBtn.className = 'page-btn';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; render(); } };
            controls.appendChild(nextBtn);
        }

        window.changePageSize = () => {
            const select = document.getElementById('pageSizeSelect');
            pageSize = parseInt(select.value, 10) || 10;
            currentPage = 1;
            render();
        };

        window.setGrid = (cols, btn) => {
            const grid = document.getElementById('carsGrid');
            const buttons = document.querySelectorAll('.view-btn');
            buttons.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            grid.classList.remove('cols-2', 'cols-3');
            if (cols === 3) {
                grid.classList.add('cols-3');
                document.querySelector('.container').style.maxWidth = "1400px";
            } else {
                grid.classList.add('cols-2');
                document.querySelector('.container').style.maxWidth = "1200px";
            }
        };

        // --- MODAL & GALLERY ---
        window.openModal = (carId) => {
            const car = allCars.find(c => c._id === carId);
            if (!car) return;

            document.getElementById('modalTitle').innerText = car.title;
            document.getElementById('modalPrice').innerText = car.hidePrice 
                ? "Call for Price" 
                : `LKR ${car.price ? car.price.toLocaleString() : '0'}`;
            
            // Status
            const statusLabel = car.status || "Ready to Ship";
            let statusClass = "modal-status-ready";
            if (statusLabel.includes("Transit")) statusClass = "modal-status-transit";
            if (statusLabel.includes("Arrived")) statusClass = "modal-status-arrived";
            const statusEl = document.getElementById('modalStatus');
            statusEl.textContent = statusLabel;
            statusEl.className = `modal-status-pill ${statusClass}`;

            // Specs
            document.getElementById('modalGrade').innerText = car.grade || '-';
            document.getElementById('modalYear').innerText = car.year || '-';
            document.getElementById('modalMileage').innerText = car.mileage || '-';
            document.getElementById('modalEngine').innerText = car.engine || '-';
            document.getElementById('modalFuel').innerText = car.fuel || '-';
            document.getElementById('modalTrans').innerText = car.transmission || '-';
            document.getElementById('modalRef').innerText = car._id.slice(-6).toUpperCase(); // Short ID
            
            // Images - Use helper for full gallery
            currentCarImages = getCarImages(car.images);
            currentSlideIndex = 0;
            updateSlide();

            // WhatsApp Link
            const phone = "94714878393";
            const text = `Hi Vinvel, I am interested in the ${car.title} (Ref: ${car._id.slice(-6)}). Is it still available?`;
            document.getElementById('modalWhatsapp').href = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            
            document.getElementById('carModal').style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('carModal').style.display = 'none';
        };

        // Gallery Nav
        window.changeSlide = (direction) => {
            currentSlideIndex += direction;
            if (currentSlideIndex >= currentCarImages.length) currentSlideIndex = 0;
            if (currentSlideIndex < 0) currentSlideIndex = currentCarImages.length - 1;
            updateSlide();
        };

        function updateSlide() {
            const imgElement = document.getElementById('modalImage');
            if(currentCarImages.length > 0) {
                imgElement.src = currentCarImages[currentSlideIndex];
            } else {
                imgElement.src = "https://via.placeholder.com/800x600?text=No+Image";
            }
        }

        // --- UTILS ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('filterSidebar');
            if (sidebar.style.display === 'block') {
                sidebar.style.display = 'none';
            } else {
                sidebar.style.display = 'block';
            }
        };

        window.openWhatsApp = (e, title, id) => {
            e.preventDefault();
            const phone = "94714878393";
            const text = `Hi Vinvel, I am interested in the ${title} (Ref: ${id.slice(-6)}). Is it still available?`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        };

        // Initialize on load
        initInventory();
    </script>
</body>
</html>